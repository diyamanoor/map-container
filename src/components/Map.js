import React, { useState, useRef } from "react";
import { MapContainer, TileLayer, Marker, Popup, Polygon } from "react-leaflet";
import axios from "axios";
import "leaflet/dist/leaflet.css";
import L from "leaflet";
import markerIconUrl from "leaflet/dist/images/marker-icon.png";
import markerShadowUrl from "leaflet/dist/images/marker-shadow.png";

const apiKey = "2d95343677ec40fa91efc5daa2443a60";

const Map = () => {
  const mapRef = useRef();

  const customIcon = new L.Icon({
    iconUrl: markerIconUrl,
    shadowUrl: markerShadowUrl,
    iconSize: [25, 41], 
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41], 
  });

  const markerData = [
    { lat: 37.7749, lng: -122.4194, name: "San Francisco" },
    { lat: 37.7849, lng: -122.4094, name: "SF North" },
    { lat: 37.7649, lng: -122.4294, name: "SF South" },
    { lat: 37.7749, lng: -122.3994, name: "SF East" },
    { lat: 37.7749, lng: -122.4394, name: "SF West" },
    { lat: 34.0522, lng: -118.2437, name: "Los Angeles" },
    { lat: 34.0622, lng: -118.2537, name: "LA North" },
    { lat: 34.0422, lng: -118.2337, name: "LA South" },
    { lat: 34.0522, lng: -118.2237, name: "LA East" },
    { lat: 34.0522, lng: -118.2637, name: "LA West" },
    { lat: 40.7128, lng: -74.006, name: "New York City" },
    { lat: 40.7228, lng: -74.016, name: "NYC North" },
    { lat: 40.7028, lng: -73.996, name: "NYC South" },
    { lat: 40.7128, lng: -73.986, name: "NYC East" },
    { lat: 40.7128, lng: -74.026, name: "NYC West" },
    { lat: 51.5074, lng: -0.1278, name: "London" },
    { lat: 51.5174, lng: -0.1378, name: "London North" },
    { lat: 51.4974, lng: -0.1178, name: "London South" },
    { lat: 51.5074, lng: -0.1078, name: "London East" },
    { lat: 51.5074, lng: -0.1478, name: "London West" },
    { lat: 48.8566, lng: 2.3522, name: "Paris" },
    { lat: 48.8666, lng: 2.3622, name: "Paris North" },
    { lat: 48.8466, lng: 2.3422, name: "Paris South" },
    { lat: 48.8566, lng: 2.3322, name: "Paris West" },
  ];

  const polygons = [
    {
      positions: [
        [37.1881508561049, 21.22855385195834],
        [25.187215231566654, 21.73931263668274],
        [24.909777632540965, 19.743032412667034],
        [24.150679632595455, 20.032543216894325],
        [24.048652004507204, 19.456228876302276],
        [24.027894732105494, 15.846980611033999],
        [22.922817414317848, 15.509151255175638],
        [22.494177462811933, 14.686869203743768],
        [22.547077751076046, 14.036666831964666],
        [22.068155345431933, 13.667018596674211],
        [21.986875335201802, 12.823857227373253],
        [23.87827864526244, 9.591023098543705],
        [26.74527777240743, 9.50682333140464],
        [31.11835706814704, 9.455126924888887],
        [32.80884807256014, 10.762237013868429],
        [32.03621037747683, 11.879924493873233],
        [33.356683221736276, 12.182657667283763],
        [33.48737097936356, 10.940256713143867],
        [34.05643883392858, 9.56072212889788],
        [34.90357294515305, 11.224615241866642],
        [36.28073368959828, 12.530274577112234],
        [36.87427102047104, 15.49162714059829],
        [37.392759579596806, 17.209607334108554],
        [39.04141044595217, 17.754837258302985],
        [37.58453245256163, 18.77188626878879],
        [37.1881508561049, 21.22855385195834],
      ],
      fillColor: "blue",
      color: "blue",
      name: "Sudan",
      population: "80.50M",
    },

    {
      positions: [
        [-8.745061739844317, 27.97295003652826],
        [-8.734173240476366, 27.51165278243748],
        [-8.194990404736842, 27.218660453139208],
        [-5.038117330542576, 24.76835779138966],
        [1.074938452777758, 21.369802614690727],
        [1.3138272584776018, 20.631884785556252],
        [3.3572520832287864, 19.83282816943317],
        [3.3763085420982577, 19.149779898627187],
        [4.105462917481873, 19.10812886263274],
        [5.616907652743379, 19.388061564935995],
        [7.383192969902495, 21.01607316859814],
        [12.037868732919094, 23.51975111695681],
        [11.508345973203262, 24.02746697474801],
        [10.774914144730104, 24.72408350921276],
        [10.227552931219236, 24.730189217446068],
        [10.035407038936114, 25.482139750482546],
        [9.493780655579855, 26.17614349099084],
        [9.986811664571377, 26.613395106452387],
        [9.86103847908268, 27.372724676119375],
        [9.951224722218086, 28.390001400282955],
        [9.409260916026511, 30.13150863177907],
        [9.069483949403377, 32.03605403187848],
        [8.178594513650324, 32.972284378602495],
        [7.723124145576605, 33.579471493676735],
        [7.564942799766158, 34.260596446460056],
        [8.410697927445483, 34.811228543277224],
        [8.492999286053731, 35.78597398205676],
        [8.337673473338953, 36.492371370468774],
        [8.339050514945342, 36.99215121587709],
        [3.11948883704369, 36.82283833456236],
        [-0.7294823421821093, 35.76759909634393],
        [-2.254235682134322, 35.098468519452624],
        [-1.136021271954391, 31.937655997680515],
        [-2.7286163783383373, 32.02500792619564],
        [-3.5108846708949137, 31.71834071239234],
        [-3.822206442506628, 30.91889503061382],
        [-5.469818883901892, 29.687391724651896],
        [-7.367389935457077, 29.501066582678625],
        [-9.043194661398601, 28.742072471616986],
        [-8.745061739844317, 27.97295003652826],
      ],
      fillColor: "green",
      color: "green",
      name: "Algeria",
      population: "1.20M",
    },

    {
      positions: [
        [-17.04010135939049, 21.237640900674165],
        [-15.863603187338384, 16.53641307939597],
        [-14.384998128184407, 16.63251808674663],
        [-13.638142556497797, 15.990682448541051],
        [-12.980805502510435, 15.487398816864413],
        [-12.211590232988215, 14.844550739883033],
        [-11.719487930039207, 14.994812060115635],
        [-11.487468704977687, 15.566768947367649],
        [-10.872616747862395, 15.261007708544483],
        [-10.394823669992377, 15.34813086812467],
        [-9.103646753077811, 15.467914467549079],
        [-5.518270325594074, 15.54268416010612],
        [-5.478597562641227, 16.258687540279325],
        [-5.761780509567558, 16.676340416342228],
        [-6.618056194085938, 24.925598844885826],
        [-4.920665246029728, 24.976081906229993],
        [-8.53537019618986, 27.26150521359415],
        [-8.580289936105913, 25.994551983715937],
        [-11.91925077811564, 25.88069606627701],
        [-11.61644783853015, 23.64341022157791],
        [-12.92564798804898, 22.96838983987287],
        [-13.1593271004717, 21.328096613438802],
        [-17.04010135939049, 21.237640900674165],
      ],
      fillColor: "purple",
      color: "purple",
      name: "Mauritania",
      population: "2.50M",
    },

    {
      positions: [
        [-5.149326111804015, 24.841553005897367],
        [-6.48384293949853, 24.836695128154737],
        [-5.796454645951435, 16.531043856753218],
        [-5.432636797293558, 16.22925679244299],
        [-5.36300448059241, 15.504734743542759],
        [-10.997947519371202, 15.157198524882753],
        [-11.51038809827378, 15.58353408132399],
        [-12.311562150439215, 14.712566274351872],
        [-12.197355340704235, 14.024651580438132],
        [-11.51025082425113, 13.12653031834519],
        [-11.420413210852018, 12.608008587763592],
        [-11.124337598100709, 12.120010144128983],
        [-10.2905574377846, 12.129506986948897],
        [-9.207638351074735, 12.346785916976202],
        [-8.654336360925953, 11.365500418531695],
        [-8.185322076664562, 10.603132117869194],
        [-7.079572028330631, 10.581075817478023],
        [-6.248792089456401, 10.337458380397095],
        [-5.431709444924195, 10.735976802340545],
        [-5.503245992050921, 11.719819032495892],
        [-4.63668223442059, 11.992276549220321],
        [-4.540849791520401, 13.321355645528712],
        [-3.6174180015168815, 13.185688669873315],
        [-2.617557946529331, 14.293117222116848],
        [-0.5311518924587233, 15.019255669511011],
        [1.086748022895108, 14.838535693059825],
        [1.3844235514764591, 15.360775337415717],
        [3.0779462294387656, 15.401160100348434],
        [3.6226109098928134, 15.373758506494255],
        [4.113616865243387, 16.03678236782895],
        [4.088878661471028, 19.04741987042459],
        [3.190726203399521, 19.066244492146936],
        [3.230212708612669, 19.735944190071336],
        [2.2652009351283198, 20.221639924402112],
        [1.6515628351154135, 20.479075387989923],
        [1.0846233795298303, 20.73593231357377],
        [1.069821903488588, 21.208933015555857],
        [-5.149326111804015, 24.841553005897367],
      ],
      fillColor: "red",
      color: "red",
      name: "Mali",
      population: "0.75M",
    },

    {
      positions: [
        [-17.11229684408059, 21.31413884685793],
        [-13.37150866325672, 21.278481855760518],
        [-12.885601881190723, 22.871884162138926],
        [-11.659748363767392, 23.639238435923247],
        [-11.96392268751282, 25.869269532771227],
        [-8.693719421245163, 25.932910339810462],
        [-8.769977948351965, 27.821190155608605],
        [-13.065088481679823, 27.77592053214545],
        [-13.556000523120844, 26.583384274003308],
        [-14.483044588738068, 26.080695913671974],
        [-15.700209092675209, 24.02419580745348],
        [-16.445814415073528, 22.548520031135496],
        [-17.11229684408059, 21.31413884685793],
      ],
      fillColor: "yellow",
      color: "yellow",
      name: "Western sahara",
      population: "0.85M",
    },

    {
      positions: [
        [-13.035035762240284, 27.907627240119183],
        [-8.788161298728284, 27.838892040248183],
        [-9.117304856223285, 28.774669814667362],
        [-7.086053988991182, 29.565238065503266],
        [-5.39664121633453, 29.84666678943408],
        [-4.071336591890855, 30.926139076536757],
        [-2.974335832735335, 31.93016138823468],
        [-1.2554323595192898, 32.256355136797055],
        [-2.157602131727913, 35.078183298657265],
        [-3.5718770151273986, 35.26804729120312],
        [-4.591309909035743, 35.17153335204141],
        [-5.416249917441036, 35.894403343582226],
        [-6.644302692603219, 34.604106921624734],
        [-8.898314365925529, 32.8565329697129],
        [-9.726772731926758, 31.462719828626973],
        [-10.516853917368024, 30.78748706833167],
        [-9.385668584480698, 30.35224086612463],
        [-10.257280454141267, 29.05428906233398],
        [-13.035035762240284, 27.907627240119183],
      ],
      fillColor: "orange",
      color: "orange",
      name: "Morocco",
      population: "0.40M",
    },

    {
      positions: [
        [11.853824676534288, 23.50881889764267],
        [7.72896933370339, 21.19420587772835],
        [5.851761791973544, 19.641118210625486],
        [4.270483880507733, 19.241713698815108],
        [4.136505565450253, 15.705345922834987],
        [0.19158253279240967, 14.734729728897833],
        [0.5736330675573242, 13.883066911649792],
        [1.2239785898472064, 12.98315319432811],
        [2.1084904435186616, 12.277224904779374],
        [2.972876213154507, 12.413463885197743],
        [3.5474473793522066, 11.82785840340894],
        [3.7684773572020447, 12.427591025816213],
        [4.146447471657041, 13.508573344799046],
        [5.7554117351372724, 13.766222830429626],
        [6.942772209167856, 13.185099623189004],
        [7.8194753003242, 13.253576034769296],
        [9.20747774743299, 12.796493057692814],
        [10.470517404778576, 13.335509899691914],
        [12.532891408093178, 13.17296471333492],
        [13.659685549778288, 13.64583905266801],
        [13.582763736870362, 14.349439980191733],
        [14.15780339573962, 15.47239406985895],
        [15.523375452363666, 16.844792737288003],
        [15.961553477172771, 20.209274858315098],
        [15.368062959347128, 21.536998166097163],
        [14.945190551925577, 22.959613391672875],
        [14.243971830491574, 22.701970438906827],
        [13.576230975033866, 23.16402310136324],
        [11.853824676534288, 23.50881889764267],
      ],
      fillColor: "pink",
      color: "pink",
      name: "Niger",
      population: "0.90M",
    },

    {
      positions: [
        [14.893612451535944, 23.028439629622298],
        [16.03808367142033, 23.418588561219128],
        [19.045703269259874, 21.964904287007037],
        [24.131047393202522, 19.432221946497265],
        [24.070839258984435, 20.066491889798897],
        [25.204461245036974, 20.064516348359362],
        [24.99229010456268, 29.496355316530874],
        [25.060513279269763, 31.65096463323268],
        [23.068338436713912, 32.541208795556194],
        [20.029430248961226, 32.21590893830448],
        [20.256889260715592, 30.588260067298798],
        [18.70710130185936, 30.31798980969346],
        [15.667363091881242, 31.441169183439584],
        [13.387723887834795, 32.854583139846405],
        [11.547757646861513, 33.06668288854924],
        [10.157186104164388, 31.460779398516387],
        [10.311579551045968, 30.499596247655376],
        [9.393012776760354, 29.957335969291005],
        [10.032485519164544, 28.284414850031816],
        [9.978940165819171, 26.57549296546753],
        [9.35281155779486, 26.40960354342974],
        [10.283383549787484, 24.82303101607505],
        [12.078872063798398, 23.466792712918107],
        [13.502932741172941, 23.1573350182327],
        [14.167754248877685, 22.62420293967938],
        [14.893612451535944, 22.62420293967938],
        [14.893612451535944, 23.028439629622298],
      ],
      fillColor: "cyan",
      color: "cyan",
      name: "Libya",
      population: "0.30M",
    },

    {
      positions: [
        [25.120471198338606, 31.80088964881716],
        [25.18153292245671, 21.71616289391251],
        [37.114860482412894, 21.303091718315756],
        [35.480164670594434, 24.43050347049042],
        [33.50793447349514, 27.579342363465145],
        [32.34030022440888, 29.595071739629503],
        [31.164773989075343, 31.566804299411572],
        [29.16361599219107, 30.83685719929035],
        [26.889674001737205, 31.392750715582025],
        [25.120471198338606, 31.80088964881716],
      ],
      fillColor: "lime",
      color: "lime",
      name: "Egypt",
      population: "0.15M",
    },

    {
      positions: [
        [13.526687146291579, 13.449801256664813],
        [15.305216520968202, 11.596999391192703],
        [14.06684630635715, 9.585959373092365],
        [15.049275638987012, 8.860247040754075],
        [15.57246917141677, 7.5773214679453815],
        [16.880820211917296, 7.709884860124802],
        [18.781204338988317, 8.222001758964154],
        [19.0441524984345, 9.024569287503269],
        [20.627291412111333, 9.310079131081167],
        [21.559682236978944, 10.207384890961023],
        [21.963506047559207, 10.787100489400501],
        [23.037852344409856, 10.999554027872875],
        [21.78413214530687, 12.701577787365181],
        [22.064632520594813, 13.472162314624796],
        [22.561763154457594, 14.68407088427361],
        [22.926570476260224, 15.638086382803621],
        [24.101164889434273, 15.972736170533764],
        [24.1255600848759, 19.582079049420003],
        [16.038954900969458, 23.278167620175864],
        [14.92621910278001, 22.95316129893341],
        [16.240346491981654, 20.449568407843543],
        [15.632394151565592, 17.06466435538431],
        [13.716189031022594, 14.679142302671664],
        [13.526687146291579, 13.449801256664813],
      ],
      fillColor: "teal",
      color: "teal",
      name: "chad",
      population: "0.25M",
    },
    {
      positions: [
        [-9.350681081030615, 22.30784941116127],
        [-9.44477924483715, 22.30784941116127],
        [-9.44477924483715, 22.298755088954053],
        [-9.350681081030615, 22.298755088954053],
        [-9.350681081030615, 22.30784941116127],
      ],
      fillColor: "lime",
      color: "lime",
      name: "Paris Triangle",
      population: "1.50M",
    },
  ];

  const getPlaceName = async (lat, lng) => {
    const url = `https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lng}&key=${apiKey}`;
    try {
      const response = await axios.get(url);
      if (response.data.results && response.data.results.length > 0) {
        return response.data.results[0].formatted; // Full place name
      } else {
        return "Place name not found";
      }
    } catch (error) {
      console.error("Error fetching place name:", error);
      return "Error fetching place name";
    }
  };

  return (
    <div style={{ height: "100vh" }}>
      <MapContainer
        center={[37.7749, -122.4194]}
        zoom={5}
        style={{ width: "100%", height: "100%" }}
        ref={mapRef}
      >
        <TileLayer
          url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
          attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        />

        {/* markerData */}
        {markerData.map((marker, index) => (
          <Marker
            key={index}
            position={[marker.lat, marker.lng]}
            icon={customIcon}
            eventHandlers={{
              click: async () => {
                const mapInstance = mapRef.current;
                if (mapInstance) {
                  const placeName = await getPlaceName(marker.lat, marker.lng);
                  const popupContent = ` <div style="font-family: Arial, sans-serif; text-align: center;"> 
                  <h3 style="margin: 5px 0;">${marker.name}</h3>
                  <h4 style="margin: 5px 0;"> ${placeName}</h4> 
                  <p style="margin: 5px 0; font-size: 14px; color: gray;"> Latitude:${marker.lat}, Longitude: ${marker.lng} </p> </div> `;
                  const popup = L.popup()
                    .setLatLng([marker.lat, marker.lng])
                    .setContent(popupContent);
                  popup.openOn(mapInstance);
                }
              },
            }}
          ></Marker>
        ))}

        {/*Polygon data*/}
        {polygons.map((polygon, index) => (
          <Polygon
            key={index}
            positions={polygon.positions}
            color={polygon.color}
            weight={3}
            fillColor={polygon.fillColor}
            fillOpacity={0.2}
          >
            <Popup>
              <div
                style={{ fontFamily: "Arial, sans-serif", textAlign: "center" }}
              >
                <h2 style={{ margin: "5px 0" }}>Population Density</h2>
                <h3 style={{ margin: "5px 0" }}>{polygon.name}</h3>
                <p style={{ margin: "5px 0", fontSize: "14px", color: "gray" }}>
                  {polygon.population} People per square mile
                </p>
              </div>
            </Popup>
          </Polygon>
        ))}
      </MapContainer>
    </div>
  );
};

export default Map;
